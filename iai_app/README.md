# MVP: Интегральный индекс инвестиционной привлекательности (IAI)

Простой веб-сервис на Flask для оценки компаний по индексу IAI через OpenAI API. Пользователь вводит название компании, приложение вызывает модель для расчёта субиндексов (FSI, MPI, PTI, TMI, RRI, PI), вычисляет итоговый IAI и сохраняет результат в SQLite.

## Что умеет приложение
- Поле поиска и кнопка «Оценить» на главной странице.
- Пайплайн загрузки с шагами анализа во время запроса.
- Таблица рейтинга уже оценённых компаний (сортировка по IAI по убыванию).
- Страница компании с радар-чартом и карточками фактов по каждому субиндексу.

## Требования
- Python 3.11+
- Установленные зависимости из `requirements.txt` (`Flask`, `openai`).
- Переменная окружения `OPENAI_API_KEY` с действительным ключом OpenAI.

## Установка и запуск
1. Клонируйте репозиторий и перейдите в каталог `iai_app/`:
   ```bash
   cd iai_app
   ```
2. Создайте виртуальное окружение (пример для macOS/Linux):
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate
   ```
   Для Windows (PowerShell):
   ```powershell
   py -m venv .venv
   .\.venv\Scripts\activate
   ```
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
4. Установите ключ OpenAI:
   ```bash
   export OPENAI_API_KEY="ваш_ключ"
   ```
5. Запустите Flask-приложение:
   ```bash
   python app.py
   ```
   При первом старте таблица SQLite будет создана автоматически. Откройте в браузере http://127.0.0.1:5000.

## Пользовательский сценарий
1. Откройте главную страницу. Видно поле поиска и рейтинг компаний.
2. Введите название компании и нажмите «Оценить». Появится модалка с 4 шагами пайплайна.
3. После завершения анализа произойдёт переход на страницу компании.
4. В рейтинге можно кликнуть на любую сохранённую компанию для просмотра радара и фактов.

## Техническая архитектура
- `app.py` — Flask-приложение, роуты `/`, `/company/<slug>`, `/api/analyze`, обработчик 404.
- `db.py` — инициализация SQLite (`iai.db`), функции вставки и выборки данных.
- `iai_logic.py` — веса субиндексов, функция `evaluate_company` для запроса к OpenAI и расчёта итогового IAI, `slugify`.
- `templates/` — базовый шаблон, главная страница, страница компании и 404.
- `static/style.css` и `static/main.js` — минимальные стили и логика интерфейса (формы, модалка, радар, бейджи).

### Таблица `companies`
| Поле | Тип | Описание |
| --- | --- | --- |
| id | INTEGER PK | Идентификатор |
| slug | TEXT UNIQUE | Слаг компании (URL) |
| name | TEXT | Отображаемое название |
| iai | REAL | Итоговый IAI |
| subindices_json | TEXT | Полный JSON с тегами, субиндексами и фактами |
| created_at | DATETIME | Дата оценки (UTC) |

### Формат ответа OpenAI
Модель должна вернуть JSON вида:
```json
{
  "company_name": "ООО «ИРМ»",
  "tags": ["B2B", "нефтегаз", "софт"],
  "subindices": {
    "FSI": {"score": 7.2, "facts": [{"title": "Выручка 2024", "description": "...", "sources": ["https://..."]}]},
    "MPI": {"score": 6.8, "facts": [...]},
    "PTI": {"score": 7.5, "facts": [...]},
    "TMI": {"score": 6.0, "facts": [...]},
    "RRI": {"score": 5.5, "facts": [...]},
    "PI":  {"score": 6.2, "facts": [...]}
  }
}
```
Приложение приводит оценки к `float`, считает взвешенное среднее по весам `WEIGHTS_IAI` и округляет до одной цифры после запятой.

## Как адаптировать методологию
- Изменить веса субиндексов — редактируйте словарь `WEIGHTS_IAI` в `iai_logic.py`.
- Добавить дополнительные подсказки модели — обновите промпт в `evaluate_company`.
- Добавить поля в таблицу — измените `CREATE TABLE` в `db.py` и логику вставки/выборки.

## Ограничения MVP
- Нет авторизации и ролей.
- Анализ выполняется в рамках одного HTTP-запроса, без очередей и фоновых задач.
- Нет встроенного web-search: предполагается, что модель OpenAI сама использует доступные источники или вы добавите свой слой поиска.
- Для продакшена понадобятся тайм-ауты, кеширование и обработка ошибок API.
