{% extends 'base.html' %}
{% block content %}
<header class="page-hero">
  <div>
    <h1>{{ name }}</h1>
    <div class="tags">
      {% for tag in tags %}
        <span class="tag">{{ tag }}</span>
      {% else %}
        <span class="tag muted">теги не указаны</span>
      {% endfor %}
    </div>
    <div class="iai-badge">IAI {{ '%.1f'|format(iai) }} / 10</div>
  </div>
  <div class="meta-grid">
    <div class="meta-chip">Факты и источники с гиперссылками</div>
    <div class="meta-chip">Шкала 0–10 (бэнды и перцентили)</div>
    <div class="meta-chip">Весовая модель IAI</div>
  </div>
</header>

<section class="card-pane">
  <div class="pane-head">
    <div class="sub">Инвест‑радар (0–10)</div>
    <div class="sub">FSI · MPI · PTI · TMI · RRI · PI</div>
  </div>
  <div class="radar-wrap">
    <svg id="radar" viewBox="0 0 300 300" aria-label="Радар субиндексов"
         data-fsi="{{ subindices.get('FSI', {}).get('score', 0) }}"
         data-mpi="{{ subindices.get('MPI', {}).get('score', 0) }}"
         data-pti="{{ subindices.get('PTI', {}).get('score', 0) }}"
         data-tmi="{{ subindices.get('TMI', {}).get('score', 0) }}"
         data-rri="{{ subindices.get('RRI', {}).get('score', 0) }}"
         data-pi="{{ subindices.get('PI', {}).get('score', 0) }}">
    </svg>
  </div>
</section>

<section class="facts-section">
  <h2>Ключевые факты (основа оценок)</h2>
  <div class="facts-grid">
    {% for key, label in {'FSI':'Финансы', 'MPI':'Рынок', 'PTI':'Продукт/Технологии', 'TMI':'Команда/Управление', 'RRI':'Риски', 'PI':'Планы/Исполнение'}.items() %}
      {% set block = subindices.get(key, {}) %}
      <article class="fact-card" data-score="{{ block.get('score', 0) }}" data-key="{{ key }}">
        <header>
          <div>
            <p class="sub">{{ key }} — {{ label }}</p>
            <p class="score">{{ key }}: {{ '%.1f'|format(block.get('score', 0)) }} / 10</p>
          </div>
          <span class="badge"></span>
        </header>
        <ul class="fact-list">
          {% for fact in block.get('facts', []) %}
            <li>
              <div class="fact-title">{{ fact.title }}</div>
              <p class="fact-desc">{{ fact.description }}</p>
              {% if fact.sources %}
                <div class="sources">
                  {% for src in fact.sources %}
                    <a href="{{ src }}" target="_blank" rel="noopener">{{ src }}</a>{% if not loop.last %} · {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </li>
          {% else %}
            <li class="muted">Нет данных.</li>
          {% endfor %}
        </ul>
      </article>
    {% endfor %}
  </div>
</section>

<section class="panel">
  <div class="company-header" style="align-items:center;">
    <h2 style="margin:0">Методология IAI (внутри prompt)</h2>
    <span class="highlight">Ставим факты на рельсы: веса, метрики, источники</span>
  </div>
  <div class="methodology">
    {% for item in methodology %}
      <div class="method-card">
        <h4>{{ item.code }} — {{ item.name_en }}</h4>
        <p class="meta">{{ item.name_ru }} • {{ item.summary }} • <span class="weight">Вес: {{ item.weight }}</span></p>
        <ul>
          {% for metric in item.metrics %}
            <li>{{ metric }}</li>
          {% endfor %}
        </ul>
        <p class="muted">Опоры: {{ item.links|join('; ') }}</p>
      </div>
    {% endfor %}
  </div>
</section>
{% endblock %}
