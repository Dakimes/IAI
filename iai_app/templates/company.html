{% extends 'base.html' %}
{% block content %}
<section class="panel">
  <div class="company-header">
    <div class="company-meta">
      <h1>{{ name }}</h1>
      <p class="subtitle">Индекс инвестиционной привлекательности (IAI) • автоматическая оценка</p>
      <div class="tags">
        {% for tag in tags %}
          <span class="tag">{{ tag }}</span>
        {% else %}
          <span class="tag muted">теги не указаны</span>
        {% endfor %}
      </div>
    </div>
    <div class="iai-badge">IAI {{ '%.1f'|format(iai) }} / 10</div>
  </div>
  <div class="meta-grid">
    <div class="meta-chip">Весовая модель: 30 / 25 / 20 / 15 / 10 / 5</div>
    <div class="meta-chip">Факты + ссылки</div>
    <div class="meta-chip">Шкала 0–10 (бэнды и перцентили)</div>
  </div>
</section>

<section class="panel radar-block">
  <div class="company-header" style="align-items: center;">
    <h2 style="margin:0">Инвест‑радар (0–10)</h2>
    <span class="highlight">FSI · MPI · PTI · TMI · RRI · PI</span>
  </div>
  <div class="radar-card">
    <div id="radarContainer"
         data-fsi="{{ subindices.get('FSI', {}).get('score', 0) }}"
         data-mpi="{{ subindices.get('MPI', {}).get('score', 0) }}"
         data-pti="{{ subindices.get('PTI', {}).get('score', 0) }}"
         data-tmi="{{ subindices.get('TMI', {}).get('score', 0) }}"
         data-rri="{{ subindices.get('RRI', {}).get('score', 0) }}"
         data-pi="{{ subindices.get('PI', {}).get('score', 0) }}">
      <svg id="radar" viewBox="0 0 320 320"></svg>
    </div>
  </div>
</section>

<section class="panel facts-grid">
  <div class="company-header" style="align-items: center;">
    <h2 style="margin:0">Ключевые факты по субиндексам</h2>
    <span class="highlight">Методология ≈ как в примере tNavigator</span>
  </div>
  <div class="grid">
    {% for key, label in {'FSI':'Финансы', 'MPI':'Рынок', 'PTI':'Продукт/Технологии', 'TMI':'Команда/Управление', 'RRI':'Риски', 'PI':'Планы/Исполнение'}.items() %}
      {% set block = subindices.get(key, {}) %}
      <div class="card" data-score="{{ block.get('score', 0) }}">
        <div class="card-header">
          <h3>{{ label }}</h3>
          <span class="score">{{ key }}: {{ '%.1f'|format(block.get('score', 0)) }} / 10</span>
        </div>
        <div class="badge auto"></div>
        <div class="facts">
          {% for fact in block.get('facts', []) %}
            <div class="fact">
              <strong>{{ fact.title }}</strong>
              <p>{{ fact.description }}</p>
              {% if fact.sources %}
                <ul class="sources">
                  {% for src in fact.sources %}
                    <li><a href="{{ src }}" target="_blank" rel="noopener">{{ src }}</a></li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          {% else %}
            <p class="muted">Нет данных.</p>
          {% endfor %}
        </div>
        <div class="progress"><span></span></div>
      </div>
    {% endfor %}
  </div>
</section>

<section class="panel">
  <div class="company-header" style="align-items:center;">
    <h2 style="margin:0">Методология IAI (внутри prompt)</h2>
    <span class="highlight">Ставим факты на рельсы: веса, метрики, источники</span>
  </div>
  <div class="methodology">
    {% for item in methodology %}
      <div class="method-card">
        <h4>{{ item.code }} — {{ item.name_en }}</h4>
        <p class="meta">{{ item.name_ru }} • {{ item.summary }} • <span class="weight">Вес: {{ item.weight }}</span></p>
        <ul>
          {% for metric in item.metrics %}
            <li>{{ metric }}</li>
          {% endfor %}
        </ul>
        <p class="muted">Опоры: {{ item.links|join('; ') }}</p>
      </div>
    {% endfor %}
  </div>
</section>
{% endblock %}
